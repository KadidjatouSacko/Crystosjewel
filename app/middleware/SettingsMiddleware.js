// middleware/settingsMiddleware.js
import Setting from './models/SettingModel.js';



let settingsCache = null;
let lastUpdate = null;

export const injectSiteSettings = async (req, res, next) => {
    try {
        // Rafra√Æchir le cache toutes les 5 minutes OU si invalid√© manuellement
        const now = Date.now();
        const shouldRefresh = !settingsCache || 
                             !lastUpdate || 
                             (now - lastUpdate) > 300000 || 
                             global.settingsCacheExpired;

        if (shouldRefresh) {
            console.log('üîÑ Rechargement du cache des param√®tres...');
            
            const settings = await Setting.findAll({
                where: { is_public: true }
            });
            
            settingsCache = {};
            settings.forEach(setting => {
                if (!settingsCache[setting.section]) {
                    settingsCache[setting.section] = {};
                }
                
                let value = setting.value;
                if (setting.type === 'boolean') {
                    value = value === 'true' || value === true;
                } else if (setting.type === 'number') {
                    value = parseFloat(value);
                }
                
                settingsCache[setting.section][setting.key] = value;
            });
            
            lastUpdate = now;
            global.settingsCacheExpired = false;
            
            console.log('‚úÖ Cache param√®tres recharg√©:', Object.keys(settingsCache));
        }
        
        // Injecter dans toutes les vues
        res.locals.siteSettings = settingsCache || {};
        
        // Variables de commodit√©
        res.locals.siteName = settingsCache?.company?.company_name || 'Crystos Jewel';
        res.locals.companyEmail = settingsCache?.company?.company_email || 'contact@crystosjewel.com';
        res.locals.companyPhone = settingsCache?.company?.company_phone || '+33 1 23 45 67 89';
        
        next();
        
    } catch (error) {
        console.error('‚ùå Erreur injection param√®tres:', error);
        
        // Valeurs par d√©faut en cas d'erreur
        res.locals.siteSettings = {};
        res.locals.siteName = 'Crystos Jewel';
        res.locals.companyEmail = 'contact@crystosjewel.com';
        res.locals.companyPhone = '+33 1 23 45 67 89';
        
        next();
    }
};