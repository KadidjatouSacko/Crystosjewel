<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/bagues.css">
    <link rel="stylesheet" href="/css/global-categories.css">  <!-- NOUVEAU CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- BANNI√àRE PROMOTIONNELLE MISE EN AVANT -->
    <div class="promo-banner">
        <i class="fas fa-fire"></i>
        üî• PROMOTIONS EXCEPTIONNELLES ! Jusqu'√† -50% sur une s√©lection de bijoux üî•
        <i class="fas fa-gift"></i>
        Livraison gratuite d√®s 100‚Ç¨ d'achat !
    </div>

    <header>
        <%- include('partials/navbarre.ejs') %>
        <div class="overlay" id="overlay"></div>
    </header>

    <section class="page-banner">
        <div class="banner-content">
            <h2>Nos Bagues</h2>
            <p>Des cr√©ations d√©licates pour sublimer vos mains</p>
        </div>
    </section>

    <section class="category-intro">
        <div class="container">
            <div class="intro-content">
                <h3>L'√©l√©gance au bout des doigts</h3>
                <p>D√©couvrez notre collection de bagues en rose gold et or, orn√©es de pierres pr√©cieuses soigneusement s√©lectionn√©es. Chaque pi√®ce est con√ßue pour magnifier votre style et apporter une touche d'√©clat √† vos tenues quotidiennes ou vos occasions sp√©ciales.</p>
            </div>
        </div>
    </section>

    <!-- ===== SECTION FILTRES FONCTIONNELS ===== -->
    <section class="filters-section">
        <div class="container">
            <div class="filters-container">
                <div class="filters-header">
                    <h3 class="filters-title">
                        <i class="fas fa-filter"></i>
                        Filtrer les bijoux
                    </h3>
                    <button class="filters-toggle" onclick="toggleFilters()" type="button">
                        <i class="fas fa-chevron-down"></i>
                        Filtres
                    </button>
                </div>
                
                <div class="filters-content" id="filtersContent">
                    <form method="GET" class="filters-form">
                        <div class="filters-grid">
                            
                            <!-- Filtre Mati√®res -->
                            <div class="filter-group">
                                <h4><i class="fas fa-gem"></i> Mati√®res</h4>
                                <% if (materials && materials.length > 0) { %>
                                    <% materials.forEach(material => { %>
                                        <div class="filter-checkbox">
                                            <input type="checkbox" name="matiere" value="<%= material.id %>" 
                                                   id="mat_<%= material.id %>"
                                                   <%= filters.matiere.includes(material.id.toString()) ? 'checked' : '' %>>
                                            <label for="mat_<%= material.id %>"><%= material.name %></label>
                                        </div>
                                    <% }); %>
                                <% } %>
                            </div>
                            
                            <!-- Filtre Types -->
                            <div class="filter-group">
                                <h4><i class="fas fa-shapes"></i> Types</h4>
                                <% if (types && types.length > 0) { %>
                                    <% types.forEach(type => { %>
                                        <div class="filter-checkbox">
                                            <input type="checkbox" name="type" value="<%= type.id %>" 
                                                   id="type_<%= type.id %>"
                                                   <%= filters.type.includes(type.id.toString()) ? 'checked' : '' %>>
                                            <label for="type_<%= type.id %>"><%= type.name %></label>
                                        </div>
                                    <% }); %>
                                <% } %>
                            </div>
                            
                            <!-- Filtre Prix -->
                            <div class="filter-group">
                                <h4><i class="fas fa-euro-sign"></i> Prix</h4>
                                <div class="filter-checkbox">
                                    <input type="checkbox" name="prix" value="0-100" id="prix1"
                                           <%= filters.prix.includes('0-100') ? 'checked' : '' %>>
                                    <label for="prix1">Moins de 100‚Ç¨</label>
                                </div>
                                <div class="filter-checkbox">
                                    <input type="checkbox" name="prix" value="100-300" id="prix2"
                                           <%= filters.prix.includes('100-300') ? 'checked' : '' %>>
                                    <label for="prix2">100‚Ç¨ - 300‚Ç¨</label>
                                </div>
                                <div class="filter-checkbox">
                                    <input type="checkbox" name="prix" value="300-500" id="prix3"
                                           <%= filters.prix.includes('300-500') ? 'checked' : '' %>>
                                    <label for="prix3">300‚Ç¨ - 500‚Ç¨</label>
                                </div>
                                <div class="filter-checkbox">
                                    <input type="checkbox" name="prix" value="500-plus" id="prix4"
                                           <%= filters.prix.includes('500-plus') ? 'checked' : '' %>>
                                    <label for="prix4">Plus de 500‚Ç¨</label>
                                </div>
                            </div>
                            
                            <!-- Tri -->
                            <div class="filter-group">
                                <h4><i class="fas fa-sort"></i> Trier par</h4>
                                <select name="sort" class="filter-select" onchange="this.form.submit()">
                                    <option value="newest" <%= filters.sort === 'newest' ? 'selected' : '' %>>
                                        Plus r√©cents
                                    </option>
                                    <option value="price_asc" <%= filters.sort === 'price_asc' ? 'selected' : '' %>>
                                        Prix croissant
                                    </option>
                                    <option value="price_desc" <%= filters.sort === 'price_desc' ? 'selected' : '' %>>
                                        Prix d√©croissant
                                    </option>
                                    <option value="popularity" <%= filters.sort === 'popularity' ? 'selected' : '' %>>
                                        Popularit√©
                                    </option>
                                </select>
                            </div>
                            
                        </div>
                        
                        <div class="filters-actions">
                            <button type="submit" class="btn-filter">
                                <i class="fas fa-search"></i> Appliquer les filtres
                            </button>
                            <a href="?" class="btn-reset">
                                <i class="fas fa-times"></i> Tout effacer
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- ===== SECTION PRODUITS AVEC BADGES ET GRID 2 COLONNES MOBILE ===== -->
    <section class="products">
        <div class="container">
            <% if (jewels && jewels.length > 0) { %>
                <div class="products-grid">
                    <% jewels.forEach(jewel => { %>
                        <div class="product-card" data-jewel-id="<%= jewel.id %>">
                            
                            <!-- Badge dynamique avec priorit√©s -->
                            <% if (jewel.badge) { %>
                                <div class="product-badge <%= jewel.badge.class %>">
                                    <%= jewel.badge.text %>
                                </div>
                            <% } %>
                            
                            <div class="product-img">
                                <img src="<%= jewel.image %>" alt="<%= jewel.name %>" loading="lazy">
                            </div>
                            
                            <div class="product-info">
                                <h4 class="product-name"><%= jewel.name %></h4>
                                
                                <!-- Prix avec gestion des r√©ductions -->
                                <div class="product-price-container">
                                    <% if (jewel.hasDiscount) { %>
                                        <span class="price-current"><%= jewel.formattedCurrentPrice %></span>
                                        <span class="price-original"><%= jewel.formattedOriginalPrice %></span>
                                        <% 
                                        const savings = parseFloat(jewel.price_ttc) - (parseFloat(jewel.price_ttc) * (1 - jewel.discount_percentage / 100));
                                        %>
                                        <span class="savings-amount">
                                            √âconomisez <%= new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(savings) %>
                                        </span>
                                    <% } else { %>
                                        <span class="price-single"><%= jewel.formattedPrice %></span>
                                    <% } %>
                                </div>
                                
                                <div class="product-actions">
                                    <a href="/bijoux/<%= jewel.slug %>" class="product-btn view-jewel-btn" 
                                       data-jewel-id="<%= jewel.id %>" data-jewel-name="<%= jewel.name %>">
                                        <i class="fas fa-eye"></i> Voir le bijou
                                    </a>
                                    <!-- Les boutons favoris sont automatiquement masqu√©s par le CSS -->
                                </div>
                            </div>
                            
                            <!-- Actions admin (si user admin) -->
                            <% if (user && user.role === 'admin') { %>
                                <div class="admin-actions">
                                    <a href="/admin/bijoux/<%= jewel.slug %>/edit" class="btn-admin-small btn-edit-small" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button onclick="deleteJewel('<%= jewel.slug %>')" class="btn-admin-small btn-delete-small" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            <% } %>
                        </div>
                    <% }); %>
                </div>

                <!-- Pagination am√©lior√©e -->
                <% if (pagination && pagination.totalPages > 1) { %>
                    <div class="pagination">
                        <% if (pagination.hasPrevPage) { %>
                            <a href="?page=<%= pagination.prevPage %>&<%= new URLSearchParams(filters).toString() %>" class="page-link">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        <% } %>
                        
                        <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                            <a href="?page=<%= i %>&<%= new URLSearchParams(filters).toString() %>" 
                               class="page-link <%= pagination.currentPage === i ? 'active' : '' %>">
                                <%= i %>
                            </a>
                        <% } %>
                        
                        <% if (pagination.hasNextPage) { %>
                            <a href="?page=<%= pagination.nextPage %>&<%= new URLSearchParams(filters).toString() %>" class="page-link">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        <% } %>
                    </div>
                <% } %>
                
            <% } else { %>
                <div class="no-products">
                    <i class="fas fa-search"></i>
                    <h3>Aucune bague trouv√©e</h3>
                    <p>Essayez de modifier vos crit√®res de recherche ou <a href="?">voir toutes les bagues</a>.</p>
                </div>
            <% } %>
        </div>
    </section>

    <!-- Section testimonials (conserv√©e) -->
    <section class="testimonials">
        <div class="container">
            <div class="section-title">
                <h3>T√©moignages clients</h3>
                <p>D√©couvrez ce que nos clientes pensent de nos bagues</p>
            </div>
            <div class="testimonials-grid">
                <% if (category && category.testimonials) { %>
                    <% category.testimonials.forEach(testimonial => { %>
                        <div class="testimonial-card">
                            <div class="stars">
                                <% for (let i = 1; i <= 5; i++) { %>
                                    <% if (i <= Math.floor(testimonial.stars)) { %>
                                        <i class="fas fa-star"></i>
                                    <% } else if (i === Math.ceil(testimonial.stars) && testimonial.stars % 1 !== 0) { %>
                                        <i class="fas fa-star-half-alt"></i>
                                    <% } else { %>
                                        <i class="far fa-star"></i>
                                    <% } %>
                                <% } %>
                            </div>
                            <p>"<%= testimonial.text %>"</p>
                            <cite>- <%= testimonial.author %></cite>
                        </div>
                    <% }); %>
                <% } %>
            </div>
        </div>
    </section>

    <!-- Guide des tailles (conserv√©) -->
    <section class="size-guide">
        <div class="container">
            <div class="guide-content">
                <div class="guide-text">
                    <h3><%= category?.guide?.title || 'Guide des tailles' %></h3>
                    <p><%= category?.guide?.description || 'Trouvez la taille parfaite pour vos bagues.' %></p>
                    <ul>
                        <% if (category?.guide?.tips) { %>
                            <% category.guide.tips.forEach(tip => { %>
                                <li><%= tip %></li>
                            <% }); %>
                        <% } else { %>
                            <li>Mesurez votre doigt en fin de journ√©e</li>
                            <li>Tenez compte de la largeur de la bague</li>
                            <li>Consultez notre tableau des correspondances</li>
                        <% } %>
                    </ul>
                    <a href="/guide-tailles" class="btn-guide">Consulter le guide complet</a>
                </div>
                <div class="guide-visual">
                    <img src="/images/guide-tailles-bagues.jpg" alt="Guide des tailles bagues" loading="lazy">
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <%- include('partials/footer.ejs') %>

    <!-- JAVASCRIPT POUR FILTRES ET TRACKING -->
    <script>
        // Fonction pour les filtres
        function toggleFilters() {
            const content = document.getElementById('filtersContent');
            const toggle = document.querySelector('.filters-toggle i');
            
            if (content.style.display === 'none' || !content.style.display) {
                content.style.display = 'block';
                toggle.classList.remove('fa-chevron-down');
                toggle.classList.add('fa-chevron-up');
            } else {
                content.style.display = 'none';
                toggle.classList.remove('fa-chevron-up');
                toggle.classList.add('fa-chevron-down');
            }
        }

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Page bagues initialis√©e avec nouvelles fonctionnalit√©s');
            
            // Auto-submit sur changement de filtre
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    console.log('Filtre chang√©:', this.name, this.value, this.checked);
                    this.form.submit();
                });
            });
            
            // Tracking des vues (conserv√© et am√©lior√©)
            const viewJewelButtons = document.querySelectorAll('.view-jewel-btn, .product-btn');
            console.log('üëÅÔ∏è Boutons voir bijou trouv√©s:', viewJewelButtons.length);
            
            viewJewelButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const jewelCard = this.closest('.product-card, .jewel-card');
                    const jewelId = jewelCard?.querySelector('[data-jewel-id]')?.getAttribute('data-jewel-id') ||
                                   this.getAttribute('data-jewel-id');
                    const jewelName = jewelCard?.querySelector('.product-name, .jewel-name')?.textContent ||
                                     this.getAttribute('data-jewel-name');
                    
                    console.log('üëÅÔ∏è Clic d√©tect√© sur bijou:', { jewelId, jewelName });
                    
                    if (jewelId && jewelName) {
                        trackView(jewelId, jewelName);
                    } else {
                        console.warn('‚ö†Ô∏è Impossible de tracker la vue - donn√©es manquantes');
                    }
                });
            });

            // Fonction de suivi des vues
            function trackView(jewelId, jewelName) {
                if (!jewelId) {
                    console.warn('‚ö†Ô∏è ID bijou manquant pour tracking');
                    return;
                }
                
                console.log('üìä Envoi tracking vue:', { jewelId, jewelName });
                
                fetch('/api/track-view', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        jewelId: jewelId,
                        jewelName: jewelName 
                    })
                })
                .then(response => {
                    console.log('üì° R√©ponse tracking:', response.status);
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log(`‚úÖ Vue track√©e pour bijou ${jewelName}: ${data.views} vues`);
                    } else {
                        console.warn('‚ö†Ô∏è Erreur tracking:', data.message);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erreur lors du suivi de vue:', error);
                });
            }

            console.log('‚úÖ Syst√®me de filtres et tracking initialis√©');
        });

        // Fonction pour supprimer un bijou (admin)
        function deleteJewel(slug) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce bijou ?')) {
                fetch(`/bijoux/${slug}/supprimer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Erreur lors de la suppression');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la suppression');
                });
            }
        }
    </script>
</body>
</html>