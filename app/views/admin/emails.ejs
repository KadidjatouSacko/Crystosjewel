<!-- views/admin/emails.ejs -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - CrystosJewel Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
       <%- include('partials/navbarre.ejs') %>
    <!-- Navigation Admin -->
    <nav class="bg-indigo-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="/admin/dashboard" class="text-2xl font-bold">
                    <i class="fas fa-gem mr-2"></i>CrystosJewel Admin
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <span>Bonjour, <%= user?.firstName || 'Admin' %></span>
                <a href="/logout" class="bg-indigo-700 px-3 py-2 rounded hover:bg-indigo-800">
                    <i class="fas fa-sign-out-alt mr-1"></i>Déconnexion
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        
        <!-- Messages Flash -->
        <% if (typeof flashMessages !== 'undefined' && flashMessages.length > 0) { %>
            <% flashMessages.forEach(function(flash) { %>
                <div class="alert alert-<%= flash.type %> bg-<%= flash.type === 'error' ? 'red' : 'green' %>-100 border border-<%= flash.type === 'error' ? 'red' : 'green' %>-400 text-<%= flash.type === 'error' ? 'red' : 'green' %>-700 px-4 py-3 rounded mb-4">
                    <%= flash.message %>
                </div>
            <% }); %>
        <% } %>

        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-envelope text-indigo-600 mr-3"></i>
                        Gestion des Emails
                    </h1>
                    <p class="text-gray-600 mt-2">Administration et monitoring des emails envoyés</p>
                </div>
                <div class="flex space-x-3">
                    <button id="repairEmailsBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-wrench mr-2"></i>Réparer Emails
                    </button>
                    <button id="refreshStatsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-refresh mr-2"></i>Actualiser
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistiques des Emails -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            
            <!-- Total Envoyés -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="rounded-full bg-green-100 p-3">
                        <i class="fas fa-paper-plane text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Envoyés</p>
                        <p id="totalSent" class="text-2xl font-bold text-gray-900">
                            <%= typeof emailStats !== 'undefined' ? emailStats.totalSent : 0 %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Total Échecs -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="rounded-full bg-red-100 p-3">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Échecs</p>
                        <p id="totalFailed" class="text-2xl font-bold text-gray-900">
                            <%= typeof emailStats !== 'undefined' ? emailStats.totalFailed : 0 %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- En Attente -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="rounded-full bg-yellow-100 p-3">
                        <i class="fas fa-clock text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">En Attente</p>
                        <p id="pending" class="text-2xl font-bold text-gray-900">
                            <%= typeof emailStats !== 'undefined' ? emailStats.pending : 0 %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Aujourd'hui -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="rounded-full bg-blue-100 p-3">
                        <i class="fas fa-calendar-day text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Aujourd'hui</p>
                        <p id="todaySent" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Emails -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-cog text-indigo-600 mr-2"></i>
                Configuration Email
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Serveur SMTP
                    </label>
                    <input type="text" value="Gmail SMTP" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Email Expéditeur
                    </label>
                    <input type="email" value="<%= process.env.MAIL_USER || 'Non configuré' %>" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Email Admin
                    </label>
                    <input type="email" value="<%= process.env.ADMIN_EMAIL || 'Non configuré' %>" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Status Service
                    </label>
                    <span class="inline-flex items-center px-3 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        <i class="fas fa-check-circle mr-1"></i>
                        Opérationnel
                    </span>
                </div>
            </div>
        </div>

        <!-- Actions Rapides -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-bolt text-indigo-600 mr-2"></i>
                Actions Rapides
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg flex items-center justify-center">
                    <i class="fas fa-envelope mr-2"></i>
                    Test Email
                </button>
                
                <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg flex items-center justify-center">
                    <i class="fas fa-sync mr-2"></i>
                    Relancer Queue
                </button>
                
                <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg flex items-center justify-center">
                    <i class="fas fa-file-download mr-2"></i>
                    Export Logs
                </button>
            </div>
        </div>
    </div>

    <script>
        // JavaScript pour les actions
        document.getElementById('repairEmailsBtn').addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Réparation...';
            button.disabled = true;
            
            try {
                const response = await fetch('/admin/emails/repair', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ ' + result.message);
                } else {
                    alert('❌ Erreur: ' + result.error);
                }
                
            } catch (error) {
                alert('❌ Erreur: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });

        document.getElementById('refreshStatsBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/admin/emails/stats');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('totalSent').textContent = result.stats.totalSent;
                    document.getElementById('totalFailed').textContent = result.stats.totalFailed;
                    document.getElementById('pending').textContent = result.stats.pending;
                    document.getElementById('todaySent').textContent = result.stats.todaySent;
                }
                
            } catch (error) {
                console.error('Erreur mise à jour stats:', error);
            }
        });

        // Page chargée
        console.log('🎯 Page active marquée: /admin/emails');
        console.log('✅ Navigation complètement chargée');
    </script>

</body>
</html>