<!-- =============================================
5. views/admin/email-management/campaign-stats.ejs
============================================= -->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - CrystosJewel Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .pink-gold { color: #e91e63; }
        .bg-pink-gold { background-color: #e91e63; }
        .hover-pink-gold:hover { background-color: #c2185b; }
    </style>
</head>
<body class="bg-gray-50">
   


    <!-- ========================================
     üìß TEMPLATE: campaign-stats.ejs
     Fichier: app/views/admin/email-management/campaign-stats.ejs
     ======================================== -->

 <%- include('../../partials/navbarre.ejs') %>

<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-chart-bar"></i> Statistiques - <%= campaign.name %></h1>
        <div class="admin-actions">
            <a href="/admin/email-management/campaigns" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour
            </a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon bg-blue">
                <i class="fas fa-paper-plane"></i>
            </div>
            <div class="stat-content">
                <h3><%= campaign.emails_sent || 0 %></h3>
                <p>Emails envoy√©s</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon bg-green">
                <i class="fas fa-envelope-open"></i>
            </div>
            <div class="stat-content">
                <h3><%= campaign.emails_opened || 0 %></h3>
                <p>Emails ouverts</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon bg-purple">
                <i class="fas fa-mouse-pointer"></i>
            </div>
            <div class="stat-content">
                <h3><%= campaign.emails_clicked || 0 %></h3>
                <p>Clics</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon bg-orange">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-content">
                <h3><%= campaign.open_rate || 0 %>%</h3>
                <p>Taux d'ouverture</p>
            </div>
        </div>
    </div>

    <div class="campaign-info">
        <h3>D√©tails de la campagne</h3>
        <p><strong>Sujet:</strong> <%= campaign.subject %></p>
        <p><strong>Envoy√©e le:</strong> <%= helpers.formatDateTime(campaign.sent_at) %></p>
        <p><strong>Template:</strong> <%= campaign.template || 'Standard' %></p>
    </div>
</div>

<style>
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; }
.stat-icon { width: 50px; height: 50px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; }
.stat-icon.bg-blue { background: #3b82f6; }
.stat-icon.bg-green { background: #10b981; }
.stat-icon.bg-purple { background: #8b5cf6; }
.stat-icon.bg-orange { background: #f59e0b; }
.stat-content h3 { margin: 0; font-size: 24px; color: #1e293b; }
.stat-content p { margin: 0; color: #64748b; font-size: 14px; }
.campaign-info { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
</style>

<%- include('../../partials/footer.ejs') %>

    <script>
        // Graphique des performances par jour
        const ctx = document.getElementById('dailyStatsChart').getContext('2d');
        const dailyStats = <%- JSON.stringify(dailyStats || []) %>;
        
        const dates = dailyStats.map(d => new Date(d.date).toLocaleDateString('fr-FR'));
        const sentData = dailyStats.map(d => parseInt(d.sent_count) || 0);
        const openedData = dailyStats.map(d => parseInt(d.opened_count) || 0);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Emails Envoy√©s',
                        data: sentData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Emails Ouverts',
                        data: openedData,
                        borderColor: '#e91e63',
                        backgroundColor: 'rgba(233, 30, 99, 0.1)',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Fonction d'export
        function exportData() {
            window.open(`/admin/email-management/campaigns/<%= campaign.id %>/export?format=csv`, '_blank');
        }

        // Fonction de duplication
        async function duplicateCampaign() {
            if (!confirm('√ätes-vous s√ªr de vouloir dupliquer cette campagne ?')) {
                return;
            }

            try {
                const response = await fetch(`/admin/email-management/campaigns/<%= campaign.id %>/duplicate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    alert('Campagne dupliqu√©e avec succ√®s !');
                    window.location.href = '/admin/email-management/campaigns';
                } else {
                    alert('Erreur: ' + result.error);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la duplication');
            }
        }
    </script>
</body>
</html>